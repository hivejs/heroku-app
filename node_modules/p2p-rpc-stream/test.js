var rpc = require('./')


// Peer 1

var server1 = rpc.createServer({
  hello: function(_, reply) {
    console.log(_)
    reply(null, 'hello.')
  }
})

var serverStream1 = server1.createStream()

var clientStream1 = rpc.createClient(server1.id)


// Peer 2

var server2 = rpc.createServer({
  hello: function(_, reply) {
    reply(null, 'hello.')
    clientStream1.request('hello', 'you', console.log.bind(console, 'peer2:'))
  }
})

var serverStream2 = server2.createStream()

var clientStream2 = rpc.createClient(server2.id)


// Debug

serverStream1.on('data', console.log.bind(console, 'serverStream1'))
clientStream1.on('data', console.log.bind(console, 'clientStream1'))

serverStream2.on('data', console.log.bind(console, 'serverStream2'))
clientStream2.on('data', console.log.bind(console, 'clientStream2'))


// Connect 'em

serverStream1
  .pipe(clientStream2)
  .pipe(clientStream1)
  .pipe(serverStream2)
  .pipe(serverStream1)

clientStream2.request('hello', 'original', function(er, msg) {
  if(er) throw er
  console.log('got first reply', msg)
})