'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.curry = exports.wrap = exports.yio = undefined;

var _genFlatten = require('gen-flatten');

var _genFlatten2 = _interopRequireDefault(_genFlatten);

var _genMapThunk = require('gen-map-thunk');

var _genMapThunk2 = _interopRequireDefault(_genMapThunk);

var _is = require('@weo-edu/is');

var _is2 = _interopRequireDefault(_is);

var _assert = require('assert');

var _assert2 = _interopRequireDefault(_assert);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Curry yio
 * @param  {Thunk} io Async item controlor.
 * @param  {Generator} control control of items to control.
 * @return {Function|Promise}
 */

function curry(io, control) {
  (0, _assert2.default)(_is2.default.function(io), 'First argument to curry must be a function.');
  if (io && control) return yio(io, control);
  return function curriedYio(control) {
    for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
      args[_key - 1] = arguments[_key];
    }

    return yio.apply(undefined, [io, control].concat(args));
  };
}

/**
 * Wrap yio in function
 * @param  {Thunk} io
 * @param  {Generator} control
 * @return {Function}
 */

function wrap(io, control) {
  (0, _assert2.default)(_is2.default.function(io), 'First argument to wrap must be a function.');

  if (io && control) {
    return function () {
      for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
        args[_key2] = arguments[_key2];
      }

      return yio.apply(undefined, [io, control].concat(args));
    };
  }

  if (io.name === 'curriedYio') {
    return function (control) {
      return function () {
        for (var _len3 = arguments.length, args = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
          args[_key3] = arguments[_key3];
        }

        return io.apply(undefined, [control].concat(args));
      };
    };
  }

  return function (control) {
    return function () {
      for (var _len4 = arguments.length, args = Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {
        args[_key4] = arguments[_key4];
      }

      return yio.apply(undefined, [io, control].concat(args));
    };
  };
}

/**
 * yio
 * @param  {Thunk} io Async item controlor.
 * @param  {Generator} control control of items to control.
 * @param  {Array} ...args Initial arguments to control.
 * @return {Promise}
 */

function yio(io, control) {
  for (var _len5 = arguments.length, args = Array(_len5 > 2 ? _len5 - 2 : 0), _key5 = 2; _key5 < _len5; _key5++) {
    args[_key5 - 2] = arguments[_key5];
  }

  return _genMapThunk2.default.apply(undefined, [filter(io), (0, _genFlatten2.default)(control)].concat(args));
}

/**
 * Filter
 * @param  {Thunk} io
 * @return {Function}
 */

function filter(io) {
  return function (action) {
    if (_is2.default.undefined(action) || _is2.default.promise(action)) {
      return action;
    } else if (_is2.default.function(action.map)) {
      return action.map(io);
    } else {
      return io(action);
    }
  };
}

exports.default = curry;
exports.yio = yio;
exports.wrap = wrap;
exports.curry = curry;